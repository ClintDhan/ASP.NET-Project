@{
  Layout = "~/Views/Shared/AdminLayout.cshtml";
}

@section Title {
Admin Projects
}

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
  integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.3/dist/umd/popper.min.js"
  integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/js/bootstrap.min.js"
  integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

<div class="header-color"></div>

<div class="card-container">
  <div class="btn-right">
    <button type="button" class="btn btn-primary add-proj" data-bs-toggle="modal" data-bs-target="#addProjectModal">
      <i class="bi bi-plus-circle-fill"></i>Add Project
    </button>
  </div>
  <!-- Project List Table -->
  <div class="project-container">
    <div class="scroll-container">
      <table id="example" class="table table-striped" style="width:100%">
        <thead>
          <tr>
            <th>#</th>
            <th>Project Name</th>
            <th>Start Date</th>
            <th>Due Date</th>
            <th>Status</th>
            <th>Condition</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          @foreach (var project in Model.Projects)
          {
            <tr>
              <td style="text-align: center;">@project.Id</td>
              <td>@project.Name</td>
              <td>@project.StartDate.ToString("yyyy-MM-dd")</td>
              <td>@project.EndDate.ToString("yyyy-MM-dd")</td>
              <td>@project.Status</td>
             <td>@(project.IsActive ? "Active" : "Inactive")</td>
              <td>
                <div class="btn-group">
                  <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown"
                    aria-expanded="false">
                    Action
                  </button>
                  <ul class="dropdown-menu">
                    <li>
                      <a class="dropdown-item" href="@Url.Action("ViewProject", "Home", new { projectId = project.Id })">
                        View
                      </a>
                    </li>

                    <li>
                      <button class="dropdown-item btn btn-warning edit-project" data-project-id="@project.Id"
                        data-project-name="@project.Name" data-project-manager-id="@project.ProjectManagerId"
                        data-start-date="@project.StartDate.ToString("yyyy-MM-dd")"
                        data-end-date="@project.EndDate.ToString("yyyy-MM-dd")" data-description="@project.Description"
                        data-status="@project.Status" data-bs-toggle="modal" data-bs-target="#editProjectModal">
                        Edit
                      </button>
                    </li>
                  </ul>
                </div>
              </td>

            </tr>
          }
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Add Project Modal -->
<div class="modal fade" id="addProjectModal" tabindex="-1" role="dialog" aria-labelledby="addProjectLabel"
  aria-hidden="true">
  <div class="modal-dialog modal-lg custom-modal-size">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addProjectLabel">Add Project</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="/Home/CreateProject">
        <div class="modal-body">
          <div class="flx-row">
            <div>
              <label for="projectName">Project Name:</label><br>
              <input type="text" id="projectName" name="projectName" required>
            </div>
            <div style="margin-left: 1rem;">
              <label for="projectManagerId">Project Manager:</label><br>
              <select id="projectManagerId" name="projectManagerId" required>
                <option value="">Select Project Manager</option>
                @foreach (var manager in Model.ProjectManagers)
                {
                  <option value="@manager.Id">@manager.UserName</option>
                }
              </select>
            </div>
          </div>

          <div class="flx-row">
            <div>
              <label for="startDate">Start Date:</label><br>
              <input type="date" id="startDate" name="startDate" value="@DateTime.Now.ToString("yyyy-MM-dd")"
                required />
            </div>
            <div style="margin-left: 1rem;">
              <label for="endDate">Due Date:</label><br>
              <input type="date" id="endDate" name="dueDate" required />
            </div>
          </div>

          <div class="flx-row">
            <div id="membersContainer">
              <label for="members">Members:</label><br>
              <select name="members[]" id="members1" required>
                @foreach (var user in ViewBag.Users)
                {
                  <option value="@user.Id">@user.UserName</option>
                }
              </select>
            </div>
          </div>

          <div class="flx-row">
            <div>
              <label for="description">Description:</label><br>
              <textarea class="form-control text-area-desc" id="description" name="description" rows="3"
                required></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-outline-primary" id="addMemberButton">
            <i class="bi bi-plus-circle-fill"></i>
          </button>
          <button type="button" class="btn btn-outline-danger" id="removeMemberButton">
            <i class="bi bi-plus-circle-fill"></i>
          </button>
          <button type="submit" class="btn btn-primary">Save changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Project Modal -->
<!-- Edit Project Modal -->
<div class="modal fade" id="editProjectModal" tabindex="-1" role="dialog" aria-labelledby="editProjectLabel"
  aria-hidden="true">
  <div class="modal-dialog modal-lg custom-modal-size">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editProjectLabel">Edit Project</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="/Home/EditProject">
        <div class="modal-body">
          <input type="hidden" id="projectId" name="projectId" />
          <div class="flx-row">
            <div>
              <label for="editProjectName">Project Name:</label><br>
              <input type="text" id="editProjectName" name="projectName" required />
            </div>
            <div style="margin-left: 1rem;">
              <label for="editProjectManagerId">Project Manager:</label><br>
              <select id="editProjectManagerId" name="projectManagerId" required>
                <option value="">Select Project Manager</option>
                @foreach (var manager in Model.ProjectManagers)
                {
                  <option value="@manager.Id">@manager.UserName</option>
                }
              </select>
            </div>
          </div>

          <div class="flx-row">
            <div>
              <label for="editStartDate">Start Date:</label><br>
              <input type="date" id="editStartDate" name="startDate" required />
            </div>
            <div style="margin-left: 1rem;">
              <label for="editEndDate">Due Date:</label><br>
              <input type="date" id="editEndDate" name="endDate" required />
            </div>
          </div>

          <div class="flx-row">
            <div id="editMembersContainer">
              <label for="editMembers">Members:</label><br>
              <select name="members[]" id="editMembers" required>
                @foreach (var user in ViewBag.Users)
                {
                  <option value="@user.Id">@user.UserName</option>
                }
              </select>
            </div>
            <div style="margin-left: 1rem;">
              <label for="">Condition:</label>
              <select name="IsActive" id="">
                <option value="true">Active</option>
                <option value="false">InActive</option>
              </select>
            </div>
          </div>

          <div class="flx-row">
            <div>
              <label for="editDescription">Description:</label><br>
              <textarea class="form-control text-area-desc" id="editDescription" name="description" rows="3"
                required></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-outline-primary" id="addEditMemberButton">
            <i class="bi bi-plus-circle-fill"></i>
          </button>
          <button type="button" class="btn btn-outline-danger" id="removeEditMemberButton">
            <i class="bi bi-plus-circle-fill"></i>
          </button>
          <button type="submit" class="btn btn-primary">Save changes</button>
        </div>
      </form>
    </div>
  </div>
</div>




@section Scripts {
  <script>
    $(document).ready(function () {
      let memberCount = 1; // Initial member count for the add project modal
      let editMemberCount = 1; // Initial member count for the edit project modal

      // Add Member Button for Add Project Modal
      $('#addMemberButton').on('click', function () {
        memberCount++;
        $('#membersContainer').append(`
              <select name="members[]" id="members${memberCount}" required>
    @foreach (var user in ViewBag.Users)
    {
                      <option value="@user.Id">@user.UserName</option>
    }
              </select><br>
            `);
      });

      // Remove Member Button for Add Project Modal
      $('#removeMemberButton').on('click', function () {
        if (memberCount > 1) {
          $('#membersContainer select:last').remove();
          memberCount--;
        } else {
          alert('At least one member must be added.');
        }
      });

      // Edit Project Button
      $('.edit-project').on('click', function () {
        const projectId = $(this).data('project-id');
        const projectName = $(this).data('project-name');
        const projectManagerId = $(this).data('project-manager-id');
        const startDate = $(this).data('start-date');
        const endDate = $(this).data('end-date');
        const description = $(this).data('description');

        $('#projectId').val(projectId);
        $('#editProjectName').val(projectName);
        $('#editProjectManagerId').val(projectManagerId);
        $('#editStartDate').val(startDate);
        $('#editEndDate').val(endDate);
        $('#editDescription').val(description);



        // Fetch and populate members for the selected project
        $.ajax({
          url: `/Home/GetProjectMembers/${projectId}`,
          method: 'GET',
          success: function (members) {
            members.forEach(member => {
              $('#editMembersContainer').append(`
                    <select name="members[]" id="editMembers${editMemberCount + 1}" required>
                      <option value="${member.Id}" selected>${member.UserName}</option>
                    </select><br>
                  `);
              editMemberCount++; // Increment the member count
            });
          },
          error: function (xhr, status, error) {
            console.error("Error fetching members: ", error);
          }
        });

        $('#editProjectModal').modal('show');
      });

      // Add Member Button for Edit Project Modal
      $('#addEditMemberButton').on('click', function () {
        editMemberCount++;
        $('#editMembersContainer').append(`
              <select name="members[]" id="editMembers${editMemberCount}" required>
    @foreach (var user in ViewBag.Users)
    {
                      <option value="@user.Id">@user.UserName</option>
    }
              </select><br>
            `);
      });

      // Remove Member Button for Edit Project Modal
      $('#removeEditMemberButton').on('click', function () {
        if (editMemberCount > 1) {
          $('#editMembersContainer select:last').remove();
          editMemberCount--;
        } else {
          alert('At least one member must be added.');
        }
      });
    });
     document.querySelector('.collapse-btn').classList.add("active");
        document.querySelector('.bi-send-fill').style.color = "white";
        document.querySelector('.collapse-btn').style.color = "white";
  </script>
}
